<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å†å²æ•°æ® - è—çº¢èŠ±åŸ¹è‚²ç³»ç»Ÿ</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; background: #f6f7fb; color: #333; }
    header { background: #1a73e8; color: #fff; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; }
    header a { color: #fff; text-decoration: none; margin-right: 12px; }
    main { padding: 16px; max-width: 1100px; margin: 0 auto; }
    .filters { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 16px; }
    .filters input, .filters button { padding: 8px 10px; font-size: 14px; }
    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 920px) { .grid { grid-template-columns: 1fr 1fr; } }
    .card { background: #fff; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); padding: 12px; }
    .card h3 { margin: 6px 8px 12px; font-size: 16px; color: #1a73e8; }
    #status { margin: 8px 0 16px; color: #666; font-size: 13px; }
    .muted { color: #777; font-size: 13px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
</head>
<body>
  <header>
    <div>ğŸ“ˆ å†å²æ•°æ® - è—çº¢èŠ±åŸ¹è‚²ç³»ç»Ÿ</div>
    <nav>
      <a href="/">è¿”å›å®æ—¶</a>
      <a href="/history">å†å²</a>
    </nav>
  </header>
  <main>
    <div class="filters">
      <label>å¼€å§‹æ—¶é—´ <input id="start" type="datetime-local" /></label>
      <label>ç»“æŸæ—¶é—´ <input id="end" type="datetime-local" /></label>
      <input id="limit" type="number" min="10" max="1000" step="10" value="200" />
      <button id="load">åŠ è½½</button>
      <button id="export">å¯¼å‡º CSV</button>
      <span id="status" class="muted">å°±ç»ª</span>
    </div>

    <div class="grid">
      <div class="card">
        <h3>æ¸©åº¦ / æ¹¿åº¦</h3>
        <div id="chart-th" style="height: 360px;"></div>
      </div>
      <div class="card">
        <h3>å…‰ç…§ / åœŸå£¤æ¹¿åº¦</h3>
        <div id="chart-ls" style="height: 360px;"></div>
      </div>
    </div>

    <p class="muted">æç¤ºï¼šæ—¶é—´èŒƒå›´ä¸ºç©ºæ—¶å°†åŠ è½½æœ€è¿‘çš„ N æ¡è®°å½•ï¼ˆé»˜è®¤ 200ï¼‰ã€‚æ•°æ®æ¯10ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ã€‚</p>
  </main>

  <script>
    const api = {
      history: '/api/v1/sensors/history'
    };

    const el = (id) => document.getElementById(id);

    const thChart = echarts.init(el('chart-th'));
    const lsChart = echarts.init(el('chart-ls'));

    function toDateTimeLocalString(d) {
      const pad = (n)=> String(n).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }

    function dtLocalToQuery(v) {
      // Convert datetime-local value to 'YYYY-MM-DD HH:MM:SS'
      if (!v) return '';
      return v.replace('T', ' ');
    }

    async function loadData() {
      const s = dtLocalToQuery(el('start').value);
      const e = dtLocalToQuery(el('end').value);
      const limit = Math.max(10, Math.min(1000, parseInt(el('limit').value || '200')));

      const qs = new URLSearchParams();
      if (s) qs.set('start', s);
      if (e) qs.set('end', e);
      qs.set('limit', String(limit));

      el('status').textContent = 'åŠ è½½ä¸­...';
      try {
        const resp = await fetch(`${api.history}?${qs.toString()}`);
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const json = await resp.json();
        const items = json.items || [];
        // items ä¸ºæŒ‰ id DESC æ’åºï¼Œç»˜å›¾éœ€è¦æ—¶é—´å‡åº
        items.reverse();

        const xs = items.map(r => r.timestamp);
        const temp = items.map(r => r.temperature);
        const humi = items.map(r => r.humidity);
        const lux = items.map(r => r.lux);
        const soil = items.map(r => r.soil);

        thChart.setOption({
          tooltip: { trigger: 'axis' },
          legend: { data: ['æ¸©åº¦(Â°C)','æ¹¿åº¦(%)'] },
          xAxis: { type: 'category', data: xs },
          yAxis: [
            { type: 'value', name: 'æ¸©åº¦(Â°C)' },
            { type: 'value', name: 'æ¹¿åº¦(%)' }
          ],
          series: [
            { name: 'æ¸©åº¦(Â°C)', type: 'line', data: temp, smooth: true },
            { name: 'æ¹¿åº¦(%)', type: 'line', yAxisIndex: 1, data: humi, smooth: true }
          ]
        });

        // å åŠ çŒæº‰äº‹ä»¶åŒºé—´
        let intervals = [];
        try {
          const logQs = new URLSearchParams();
          if (s) logQs.set('start', s);
          if (e) logQs.set('end', e);
          logQs.set('actuator', 'pump');
          logQs.set('limit', '500');
          const logsResp = await fetch('/api/v1/control/logs?' + logQs.toString());
          if (logsResp.ok) {
            const logsJson = await logsResp.json();
            const logs = (logsJson.items || []).slice().reverse(); // æ—¶é—´å‡åº
            let currentStart = null;
            for (const it of logs) {
              if (it.action === 'on' && !currentStart) {
                currentStart = it.created_at || it.timestamp || it.time || it.createdAt || it.ts;
              } else if (it.action === 'off' && currentStart) {
                const endTs = it.created_at || it.timestamp || it.time || it.createdAt || it.ts;
                if (currentStart && endTs) {
                  intervals.push([
                    { xAxis: currentStart },
                    { xAxis: endTs }
                  ]);
                }
                currentStart = null;
              }
            }
          }
        } catch (err) {
          console.warn('åŠ è½½çŒæº‰æ—¥å¿—å¤±è´¥', err);
        }

        lsChart.setOption({
          tooltip: { trigger: 'axis' },
          legend: { data: ['å…‰ç…§(lux)','åœŸå£¤(%)','çŒæº‰åŒºé—´'] },
          xAxis: { type: 'category', data: xs },
          yAxis: [
            { type: 'value', name: 'å…‰ç…§(lux)' },
            { type: 'value', name: 'åœŸå£¤(%)' }
          ],
          series: [
            { name: 'å…‰ç…§(lux)', type: 'line', data: lux, smooth: true },
            { name: 'åœŸå£¤(%)', type: 'line', yAxisIndex: 1, data: soil, smooth: true,
              markArea: intervals.length ? {
                itemStyle: { color: 'rgba(40,167,69,0.12)' },
                data: intervals
              } : undefined
            }
          ]
        });

        el('status').textContent = `åŠ è½½å®Œæˆï¼š${items.length} æ¡`;
      } catch (err) {
        console.error(err);
        el('status').textContent = 'åŠ è½½å¤±è´¥ï¼š' + err.message;
      }
    }

    // åˆå§‹åŒ–æ—¥æœŸï¼šé»˜è®¤ç©ºï¼ˆæœ€è¿‘Næ¡ï¼‰ï¼›æä¾›å¿«æ·æœ€è¿‘1å°æ—¶ç¤ºä¾‹
    function initDefaults() {
      const now = new Date();
      const h1ago = new Date(now.getTime() - 60*60*1000);
      // ç¤ºä¾‹ï¼šå¦‚éœ€é»˜è®¤æ˜¾ç¤ºæœ€è¿‘1å°æ—¶ï¼Œå¯å–æ¶ˆæ³¨é‡Š
      // el('start').value = toDateTimeLocalString(h1ago);
      // el('end').value = toDateTimeLocalString(now);
    }

    el('export').addEventListener('click', () => {
      const s = dtLocalToQuery(el('start').value);
      const e = dtLocalToQuery(el('end').value);
      const limit = Math.max(10, Math.min(1000, parseInt(el('limit').value || '200')));
      const qs = new URLSearchParams();
      if (s) qs.set('start', s);
      if (e) qs.set('end', e);
      qs.set('limit', String(limit));
      window.open('/api/v1/sensors/history.csv?' + qs.toString(), '_blank');
    });

    el('load').addEventListener('click', loadData);
    window.addEventListener('resize', () => { thChart.resize(); lsChart.resize(); });

    initDefaults();
    loadData();
    setInterval(loadData, 10000);
  </script>
</body>
</html>

